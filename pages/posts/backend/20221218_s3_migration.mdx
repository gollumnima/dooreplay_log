---
title: 'S3 버킷에 블로그 정적파일 띄우기'
date: 'December 18, 2022'
description: '개발 블로그를 S3 버킷에 올리는 고군분투기'
thumbnail: ''
---

  ### 시작은 배포 커맨드가 꼬인 것부터... 
  기존에는 package.json에 아래와 같은 배포 커맨드를 사용하고 있었다.
  어떤 블로그에서 퍼왔던 것 같은데 기억이 안난다... 감사합니다 작성자님ㅠㅠ
<br />
  ```js
  "deploy": "rm -rf node_modules/.cache && next build && next export && touch out/.nojekyll && git add -f out/ && git checkout -b temp-for-deploy-gh-pages && git commit -m \"Deploy Next.js to gh-pages\" && git subtree split --prefix out -b gh-pages && git push -f origin gh-pages:gh-pages && git branch -D gh-pages && git checkout main && git branch -D temp-for-deploy-gh-pages"
  ```
<br />
  하지만, 언제부턴가 이 커맨드를 실행했을 때 gh-pages 브랜치 관련해서 이슈가 있었는데 기억이 잘 나지 않는다..
  캡쳐를 분명 해두었던것 같은데 어디로 도망간 것 같다..! 
  그래서 배포된 도메인에 접속하면 구버전의 블로그만 확인할 수 있었고.. 겉으로 보기엔 크게 달라지지 않았지만 나는 많이 바꿨는데 좀 억울하기도 했고!
  다른 프로젝트를 구상하면서 서브도메인을 넣으면서 여러 프로젝트를 효율적으로 관리하고 싶어서 S3 버킷에 블로그를 올리기로 했다.

<br />
  ### 버킷 만들기
  일단 도메인을 구매하는 일부터 시작해야 하는데 나는 호스팅케이알에서 도메인을 구매했다.
  AWS S3에 버킷 만들기를 하는데 다른 블로그 검색하면 과정들이 상세하게 잘 써있고, 여기에 따로 설명을 적을 생각은 없다.
  왜냐면 기록하고 싶은 것만 기록하려는 용도로 블로그를 다시 시작했기 때문에..!

  어쨌든.. 내가 생각하기에 꼭 알아둬야 할 것들.
  <br />
  - 1버킷 1도메인(버킷 이름은 도메인과 동일하게)
  - 서브도메인을 사용할거면 버킷 이름은 서브도메인을 포함한 전체 도메인으로 설정하기
  - 속성 탭에서 정적 웹사이트 호스팅 활성화시키고 인덱스 문서와 에러 문서에 index.html 입력하기
  - 권한 탭에서 버킷 정책 만들때 권한 생성기로 만드는데
    - "Principal": "*"
    - "Action": "s3:GetObject" -> 이건 다른걸로 설정해도 될 것 같은데 다시 찾아봐야쥐! 
    - "Resource": "arn:aws:s3:::도메인이름/*"
  <br />
### Routes 53으로 돌아가서
  - 호스팅 영역에 도메인 이름을 클릭해준다.
  - 이 때, 서브도메인 포함한 호스팅영역 생성하지 말고 내가 구매한 도메인 주소 클릭!
  - 레코드 생성을 새로 해주는데 이 때 서브도메인 입력하면 된당
  - 별칭 체크하고 S3 버킷 선택해주면 끝!
  <br />

### S3에 정적파일 업로드하고 숨죽여 지켜보기
  next로 만든 프로젝트니까 처음에는 out폴더를 통으로 올렸는데 이렇게 올리면 index.html 경로를 못 찾는 것 같았다.
  그래서 지우고 다시 out폴더 안의 알맹이들만 업로드 하고 나니 바로 메인 페이지가 잘 뜬다!!
  하지만.. 문제가 하나 더 있었는데.. 그것은 바로바로 메인페이지 이외의 다른 페이지로 이동할 때 발생하는 404 에러.
  물론 내가 에러 페이지도 index.html로 설정해두어서 보이기론 메인 페이지가 뜨지만 네트워크 탭을 보면 404 에러가 뙇..!

  <a href='https://stackoverflow.com/questions/57438566/next-js-export-static-s3-routing-fails-on-page-reload'>이 글</a>을 읽어보면 답변 중에 S3에 업로드한 html파일의 생성자를 지우면 작동을 잘 한다는 의견이 있다.
  해봤더니 진짜 작동이 잘 된다! 하지만 그다지 좋은 방법 같진 않아 보였고 다른 방법을 찾았다.
  Next 공식 문서에는 next config 파일에 `trailingSlash: true`를 추가하라고 해서 해보니 라우팅이 잘 작동했다!
  배갠두 선생님과 함께 했던 php 찍먹 시간을 곰곰히 떠올려보면.. 
  index.php 파일을 읽으려면 주소창에 /를 입력했던 것 같기도..?!
  이게 바로 아파치 스타일이라는 것 같은데 흠 어렵다 어려워.. 이렇게 친해지는 것인가

  어쨌든 블로그를 버킷으로 마이그레이션 하기 성공! 이걸 마이그레이션이라고 하기도 좀 우습지만 일단 이사는 이사니까.
  이제 블로그를 더 이쁘게 꾸며보자! 👉 왼쪽의 글씨 코파일럿이 썼음 내가 쓴거 아님

### NEXT TODO..?
  다들 클라우드 프론트를 많이 쓰는데 왜 쓰는지 궁금증을 풀어볼 시간을 다음 번에 가져보자.
  속도가 빠른 것 뿐만 아니라 캐싱이랑 람다엣지까지 쓸 수 있다고 하는데 람다엣지도 나중에 검색해봐야쥐!
